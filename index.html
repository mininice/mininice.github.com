
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>mininice</title>
  <meta name="author" content="mininice">

  
  <meta name="description" content="全局模式安装包 将包安装为全局可用的可执行命令， 并非可以从任意地方require
将 package.json中bin定义的文件软链到统一的目录下， 该目录可以通过如下方式推算出来: path.resolve(process.execPath, &lsquo;..&rsquo;, &lsquo &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://mininice.github.io">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.bak.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="mininice" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/lib/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">mininice</a></h1>
  
    <h2>只怕自己投降</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:mininice.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/02/12/nodexue-xi-bi-ji-2-npmbao-guan-li/">Node学习笔记2 —— Npm包管理</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-02-12T14:17:00+08:00" pubdate data-updated="true">Feb 12<span>th</span>, 2014</time>
        

        
      </p>
    
  </header>


  <div class="entry-content"><h3>全局模式安装包</h3>

<ul>
<li>将包安装为全局可用的可执行命令， 并非可以从任意地方require</li>
<li>将 package.json中bin定义的文件软链到统一的目录下， 该目录可以通过如下方式推算出来: path.resolve(process.execPath, &lsquo;..&rsquo;, &lsquo;..&rsquo;, &lsquo;lib&rsquo;, &lsquo;node_modules&rsquo;);</li>
</ul>


<h3>npm钩子命令</h3>

<p>package.json中定义scripts字段， 如：</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="nx">script</span><span class="s2">&quot;: {</span>
</span><span class='line'><span class="s2">    &quot;</span><span class="nx">preinstall</span><span class="s2">&quot;: &quot;</span><span class="nx">preinstall</span><span class="p">.</span><span class="nx">js</span><span class="s2">&quot;,</span>
</span><span class='line'><span class="s2">    &quot;</span><span class="nx">install</span><span class="s2">&quot;: &quot;</span><span class="nx">install</span><span class="p">.</span><span class="nx">js</span><span class="s2">&quot;,</span>
</span><span class='line'><span class="s2">    &quot;</span><span class="nx">uninstall</span><span class="s2">&quot;: &quot;</span><span class="nx">uninstall</span><span class="p">.</span><span class="nx">js</span><span class="s2">&quot;,</span>
</span><span class='line'><span class="s2">    &quot;</span><span class="nx">test</span><span class="s2">&quot;: &quot;</span><span class="nx">test</span><span class="p">.</span><span class="nx">js</span><span class="err">&quot;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>npm install</h3>

<ul>
<li>可以从本地安装，也可以从某个可访问地址安装, 只需要相应的存在package.json的包说明文件</li>
<li>npm install &lt;tarball file></li>
<li>npm install &lt;tarball url></li>
<li>npm install &lt;folder></li>
</ul>


<h3>npm ls</h3>

<p>通过npm ls 命令确定当前目录下是否能通过require顺利引入想要的包</p>

<h3>AMD CMD 的模块定义规范</h3>

<ul>
<li>AMD 是 RequireJS 在推广过程中对模块定义的规范化产出</li>
<li>CMD 是 SeaJS 在推广过程中对模块定义的规范化产出</li>
<li>是CommonJS模块规范的一个延伸， 用于浏览器端模块加载机制的设计</li>
</ul>


<h4>YUI &amp; SeaJS &amp; RequireJS 比较</h4>

<ul>
<li>YUI 模块加载后， 模块会被存入到相应的命名空间下， 所以需要配合命令空间来进行模块的管理</li>
<li>而npm通过export 和同步require 来使用模块中的内容， 对浏览器端UI响应性能有一定的影响；</li>
</ul>


<p>TODO SeaJS RequireJS源码阅读</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/02/12/nodexue-xi-bi-ji-1-requirefang-fa-zhong-de-wen-jian-cha-zhao-ce-lue/">Node学习笔记1——require参数查找策略</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-02-12T14:15:00+08:00" pubdate data-updated="true">Feb 12<span>th</span>, 2014</time>
        

        
      </p>
    
  </header>


  <div class="entry-content"><h3>require参数类型</h3>

<ul>
<li>http、fs、path等,原生模块</li>
<li>￼./mod或../mod,相对路径的文件模块</li>
<li>/pathtomodule/mod,绝对路径的文件模块</li>
<li>mod,非原生模块的文件模块</li>
</ul>


<h3>module paths</h3>

<ul>
<li>对于每一个被加载的文件模块, 创建这个模块对象的时候,这个模块便会有一个paths属性, 其值根据当前文件的路径计算得到， 如果当前的文件路径为：/Users/jiao/workspace/test.js， 这module.paths的结果如下：</li>
</ul>


<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="p">[</span> <span class="s1">&#39;/Users/jiao/workspace/node_modules&#39;</span><span class="p">,</span>
</span><span class='line'>  <span class="s1">&#39;/Users/jiao/node_modules&#39;</span><span class="p">,</span>
</span><span class='line'>  <span class="s1">&#39;/Users/node_modules&#39;</span><span class="p">,</span>
</span><span class='line'>  <span class="s1">&#39;/node_modules&#39;</span> <span class="p">]</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>除此之外还有一个全局module path,是当前node执行文件的相对目录 (../../lib/node)。如果在环境变量中设置了HOME目录和NODE_PATH目录的 话,整个路径还包含NODE_PATH和HOME目录下的.node_libraries 与.node_modules</li>
</ul>


<h3>查找策略</h3>

<ul>
<li>require() 通过分析文件路径和扩展名， 找到文件， 若失败， 但却得到一个目录， node会将目录作为一个包来处理</li>
<li>包分析：查找并解析package.json， 取出main属性指定的文件名进行定位， 如果文件缺少扩展名，将会进入扩展名分析的步骤， 否则查找该目录下的index(.js|.json|.node)文件；</li>
<li>如未果， 遍历module paths，逐个执行以上步骤</li>
</ul>


<h3>JS文件编译</h3>

<p>Node.js在编译js文件的过程中实际完成的步骤有对js文件内容进行头尾包装。以app.js为例,包装之后的app.js将会 变成以下形式:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="err">￼</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">exports</span><span class="p">,</span> <span class="nx">require</span><span class="p">,</span> <span class="nx">module</span><span class="p">,</span> <span class="nx">__filename</span><span class="p">,</span> <span class="nx">__dirname</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">module</span><span class="p">.</span><span class="nx">paths</span><span class="p">);</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>



</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/02/12/js-encode/">JS URI Encode</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-02-12T13:52:00+08:00" pubdate data-updated="true">Feb 12<span>th</span>, 2014</time>
        

        
      </p>
    
  </header>


  <div class="entry-content"><p>javascript中存在几种对URL字符串进行编码的方法：escape/encodeURI/encodeURIComponent。这几种编码所起的作用各不相同。</p>

<h4>1.escape</h4>

<ul>
<li><p>采用ISO Latin字符集对指定的字符串进行编码。所有的空格符、标点符号、特殊字符以及其他非ASCII字符都将被转化成%xx格式的字符编码（xx等于该字符 在字符集表里面的编码的16进制数字）。比如，空格符对应的编码是%20。</p></li>
<li><p>不会被此方法编码的字符： @ * / +</p></li>
</ul>


<h4>2. encodeURI VS encodeURIComponent 方法</h4>

<h5>背景</h5>

<p>encodeURI 和 encodeURIComponent都是ECMA-262标准中定义的函数,兼容这个标准的语言（如JavaScript, ActionScript）都会实现这两个函数。</p>

<p>它们用来对URI （RFC-2396）字符串进行编码的全局函数，但是它们的处理方式和使用场景有所不同. RFC-2396中对于 URI中的字符分类</p>

<ul>
<li>保留字符（reserved characters）：这类字符是URI中的保留关键字符，它们用于分割URI中的各个部分。这些字符是：&#8221;;&ldquo; | &rdquo;/&ldquo; | &rdquo;?&ldquo; | &rdquo;:&ldquo; | &rdquo;@&ldquo; | &rdquo;&amp;&ldquo; | &rdquo;=&ldquo; | &rdquo;+&ldquo; | &rdquo;$&ldquo; | &rdquo;,&#8221;</li>
<li>Mark字符（mark characters）：这类字符在RFC-2396中特别定义，但是没有特别说明用途，可能是和别的RFC标准相关。 这些字符是：&#8221;&ndash;&ldquo; | &rdquo;_&ldquo; | &rdquo;.&ldquo; | &rdquo;!&ldquo; | &rdquo;~&ldquo; | &rdquo;*&ldquo; | &rdquo;&lsquo;&ldquo; | &rdquo;(&ldquo; | &rdquo;)&#8221;</li>
<li>基本字符（alphanum characters）：这类字符是URI中的主体部分，它包括所有的大写字母、小写字母和数字</li>
</ul>


<h5>encodeURI</h5>

<p>encodeURI: 该函数对传入字符串中的所有非（基本字符、Mark字符和保留字符）进行转义编码（escaping）。所有的需要转义的字符都按照UTF-8编码转化成为一个、两个或者三个字节的十六进制转义字符（％xx）</p>

<h5>encodeURIComponent</h5>

<p>该函数处理方式和encodeURI只有一个不同点，那就是对于保留字符同样做转义编码</p>

<h4>3. NodeJS 中http模块获取参数时会自动通过decodeURIComponent进行解码</h4>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kd">function</span> <span class="p">(</span><span class="nx">paramName</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">method</span> <span class="o">===</span> <span class="s2">&quot;GET&quot;</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="nb">decodeURIComponent</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">query</span><span class="p">[</span><span class="nx">paramName</span><span class="p">]);</span>
</span><span class='line'>    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">method</span> <span class="o">===</span> <span class="s2">&quot;POST&quot;</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span> <span class="o">===</span> <span class="s2">&quot;object&quot;</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">return</span> <span class="nb">decodeURIComponent</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">[</span><span class="nx">paramName</span><span class="p">]);</span>
</span><span class='line'>        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">return</span> <span class="nb">decodeURIComponent</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">)[</span><span class="nx">paramName</span><span class="p">]);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>编码导致的页面乱码</h3>

<p>对于中文字符串来说，如果不希望把字符串编码格式转化成UTF-8格式的（比如原页面和目标页面的charset是一致的时候），只需要使用escape。如果你的页面是GB2312或者其他的编码，而接受参数的页面是UTF-8编码的，就要采用encodeURI或者encodeURIComponent。</p>

<p>另外，encodeURI/encodeURIComponent是在javascript1.5之后引进的，escape则在 javascript1.0版本就有。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/11/06/iframe/">Iframe及与页面之间的通信</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-11-06T20:26:00+08:00" pubdate data-updated="true">Nov 6<span>th</span>, 2013</time>
        

        
      </p>
    
  </header>


  <div class="entry-content"><h4>获取iframe对象</h4>

<p>iframe元素本身是位于父级页面中的，所以你可以像一个普通元素一样的使用和操作它</p>

<p>代表了iframe内容window对象是作为一个页面的属性加入到iframe中的, 为了让父级页面能够以一种合适的方式获取iframe的window对象，父级页面和iframe页面的域名应该保持一致</p>

<p>iframe元素拥有名为contentDocument、parentWindow、contentWindow（全兼容）等属性</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="err">如：</span><span class="nx">iframeElement</span><span class="p">.</span><span class="nx">contentWindow</span> <span class="o">||</span> <span class="nx">iframeElement</span><span class="p">.</span><span class="nx">contentDocument</span><span class="p">.</span><span class="nx">parentWindow</span>
</span><span class='line'>
</span><span class='line'><span class="err">父级页面的</span><span class="nb">window</span><span class="err">对象在</span><span class="nx">iframe</span><span class="err">中也能够以</span><span class="nb">window</span><span class="p">.</span><span class="nx">parent</span><span class="err">获取</span>
</span></code></pre></td></tr></table></div></figure>


<h4>判断 iframe 是否加载完毕的方法（也适用于script加载）</h4>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="nx">js</span><span class="p">.</span><span class="nx">onload</span> <span class="o">=</span> <span class="nx">js</span><span class="p">.</span><span class="nx">onreadystatechange</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">readyState</span> <span class="o">||</span> <span class="k">this</span><span class="p">.</span><span class="nx">readyState</span> <span class="o">===</span> <span class="s1">&#39;loaded&#39;</span> <span class="o">||</span> <span class="k">this</span><span class="p">.</span><span class="nx">readyState</span> <span class="o">===</span> <span class="s1">&#39;complete&#39;</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="c1">// callback在此处执行</span>
</span><span class='line'>        <span class="nx">js</span><span class="p">.</span><span class="nx">onload</span> <span class="o">=</span> <span class="nx">js</span><span class="p">.</span><span class="nx">onreadystatechange</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
</span><span class='line'>        <span class="p">...</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="c1">//为了兼顾事件的一致性，改代码如下：</span>
</span><span class='line'><span class="kd">var</span> <span class="nx">iframe</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s2">&quot;iframe&quot;</span><span class="p">);</span>
</span><span class='line'><span class="nx">iframe</span><span class="p">.</span><span class="nx">src</span> <span class="o">=</span> <span class="s2">&quot;simpleinner.htm&quot;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">if</span> <span class="p">(</span><span class="nx">iframe</span><span class="p">.</span><span class="nx">attachEvent</span><span class="p">){</span>
</span><span class='line'>    <span class="nx">iframe</span><span class="p">.</span><span class="nx">attachEvent</span><span class="p">(</span><span class="s2">&quot;onload&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span>
</span><span class='line'>        <span class="nx">iframeOnload</span><span class="p">();</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'><span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">iframe</span><span class="p">.</span><span class="nx">onload</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(){</span>
</span><span class='line'>        <span class="nx">iframeOnload</span><span class="p">();</span>
</span><span class='line'>    <span class="p">};</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="nb">document</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">iframe</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="kd">function</span> <span class="nx">iframeOnload</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">alert</span><span class="p">(</span><span class="s2">&quot;Local iframe is now loaded.&quot;</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h4>iframe 解决跨域问题</h4>

<h5>什么是跨域</h5>

<p>JavaScript出于安全方面的考虑，不允许跨域调用其他页面的对象</p>

<p>因为JavaScript同源策略的限制，a.com 域名下的js无法操作b.com或是c.a.com域名下的对象, 导致了跨域问题</p>

<p>域仅仅是通过&#8221;URL的首部&#8221;来识别， &ldquo;URL的首部&#8221;指window.location.protocol+window.location.host，也可以理解为&#8221;Domains, protocols and ports must match&rdquo;</p>

<h5>方法一： document.domain + iframe</h5>

<p>解决主域相同而二级域名不同的情况， 达到两个页面相互通信的目的.</p>

<h5>方法二： iframe + location.hash</h5>

<p>解决不同域名下的两个页面的通信问题.</p>

<p>由于改变hash并不会导致页面刷新，如:<a href="http://a.com#helloword">http://a.com#helloword</a> 中的&#8217;#helloworld&#8217;就是location.hash, 所以可以利用hash来在url中传值</p>

<p>不在同一个域下的两个页面,IE、Chrome不允许修改parent.location.hash的值(Firefox可以修改), 所以需要借助一个iframe作为代理, 修改iframe上url的hash值来达到传递数据的目的, 此时在父级页面上加一个定时器，隔一段时间来获取location.hash值，如果有变化或符合处理的要求, 及关掉间隔执行，如：</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="err">先是</span><span class="nx">a</span><span class="p">.</span><span class="nx">com</span><span class="err">下的文件</span><span class="nx">cs1</span><span class="p">.</span><span class="nx">html</span><span class="err">文件：</span>
</span><span class='line'>
</span><span class='line'><span class="nx">page1</span><span class="o">:</span><span class="err">父页面</span>
</span><span class='line'><span class="kd">function</span> <span class="nx">checkHash</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">data</span> <span class="o">=</span> <span class="nx">location</span><span class="p">.</span><span class="nx">hash</span> <span class="o">?</span> <span class="nx">location</span><span class="p">.</span><span class="nx">hash</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
</span><span class='line'>        <span class="c1">//do something...</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="nx">setInterval</span><span class="p">(</span><span class="nx">checkHash</span><span class="p">,</span> <span class="mi">2000</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="nx">page2</span><span class="o">:</span> <span class="err">子页面</span>
</span><span class='line'><span class="k">try</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">parent</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">hash</span> <span class="o">=</span> <span class="s1">&#39;somedata&#39;</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="c1">// ie、chrome的安全机制无法修改parent.location.hash，</span>
</span><span class='line'>    <span class="c1">// 所以要利用一个代理iframe</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">ifrproxy</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s1">&#39;iframe&#39;</span><span class="p">);</span>
</span><span class='line'>    <span class="nx">ifrproxy</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">display</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span><span class="p">;</span>
</span><span class='line'>    <span class="nx">ifrproxy</span><span class="p">.</span><span class="nx">src</span> <span class="o">=</span> <span class="nx">page3</span> <span class="o">+</span> <span class="s1">&#39;#somedata&#39;</span><span class="p">;</span>    <span class="c1">//page3与父页面在同一个域下 </span>
</span><span class='line'>    <span class="nb">document</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">ifrproxy</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="nx">page3</span><span class="o">:</span> <span class="err">代理</span><span class="nx">iframe</span><span class="err">页面</span>
</span><span class='line'><span class="c1">//因为parent.parent和自身属于同一个域，所以可以改变其location.hash的值</span>
</span><span class='line'><span class="nx">parent</span><span class="p">.</span><span class="nx">parent</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">hash</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">hash</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<h5>缺点</h5>

<p>方法一：安全性，当一个站点（b.a.com）被攻击后，另一个站点（c.a.com）会引起安全漏洞</p>

<p>方法二：数据直接暴露在了url中，数据容量和类型都有限</p>

<h3>参考</h3>

<p><a href="http://www.cnblogs.com/rainman/archive/2011/02/20/1959325.html">http://www.cnblogs.com/rainman/archive/2011/02/20/1959325.html</a>
<a href="http://www.nczonline.net/blog/2009/09/15/iframes-onload-and-documentdomain/">http://www.nczonline.net/blog/2009/09/15/iframes-onload-and-documentdomain/</a></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/10/30/events/">事件碎碎念</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-10-30T10:52:00+08:00" pubdate data-updated="true">Oct 30<span>th</span>, 2013</time>
        

        
      </p>
    
  </header>


  <div class="entry-content"><p>事件分为：</p>

<p>1、原始事件或输入事件 与 语义事件</p>

<ul>
<li>输入事件又包括： 鼠标事件 或 键盘事件：</li>
</ul>


<p>2、与设备有关的和与设备无关的事件</p>

<h3>DOM 0级</h3>

<ul>
<li><p>onclick事件可以看着一个设备无关的事件，因为他并不依赖鼠标， 表单控件和超链接的键盘激活也会触发此事件</p></li>
<li><p>可以显示调用事件句柄， 但是不是模拟事件发生时的真正状况， 而只是执行句柄函数而已。 如：</p></li>
<li><p>调用form上的document.myform.onsubmit(); 如果onsubmit函数里面没有form.submit()的话， 就不会触发表单提交</p></li>
<li><p>事件句柄触发时，作为发生事件元素的方法调用，在函数中，关键字this指向发生事件的元素；</p></li>
</ul>


<h3>DOM2级—— 向后兼容0级</h3>

<ul>
<li><p>事件分为三个阶段： 捕获、目标节点触发、 冒泡</p></li>
<li><p>阻止冒泡： e.stopPropagation()</p></li>
<li><p>阻止默认行为： 默认行为在事件第三个阶段完成后才执行， 可使用e.preventDefault()阻止</p></li>
<li><p>可以为特定对象的特定类型事件注册任意多个处理器函数</p></li>
<li><p>DOM标准不确定调用一个对象的事件处理函数的顺序， 所以不认为他们是以注册的顺序调用</p></li>
<li><p>如果在同一个元素上多次注册了同一个处理函数， 那么第一次注册后的所有注册都将被忽略</p></li>
<li><p>e.currentTarget VS e.target &lt;=> 当前正在处理的节点 VS 发生事件的节点</p></li>
</ul>


<h3>IE的事件模型【4、5、5.5、6】—— 介于0级到2级之间</h3>

<ul>
<li><p>使用attachEvent， 只支持冒泡阶段</p></li>
<li><p>回调函数中this指向window</p></li>
<li><p>允许同一个事件句柄函数注册多次， 且事件发生的时候调用多次</p></li>
<li><p>e.srcElement： 发生事件的节点</p></li>
<li><p>e.cancelBubble=true，可以阻止当前事件进一步冒泡到包容层次的元素</p></li>
<li><p>e.returnValue=false 阻止默认行为</p></li>
</ul>


<h3>按键事件 【keydown、 keypress、 keyup】</h3>

<ul>
<li><p>在2级的DOM事件模型中没有标准化， 且不同浏览器处理的方式也有所不同</p></li>
<li><p>典型的按键会按序产生： keydown-> keypress &ndash;> keyup, 按键一直按下时，可能触发多个keypress（不同的操作系统和浏览器可能会有所不同, 实际在chrome中keydown、和keypress都会多次触发）</p></li>
<li><p>在IE中， 只有当按键有一个ASCII码的时候， 即当它是一个可打印字符或者控制字符的时候， keypress才会发生， 同时IE也会认为Alt按键组合是无法打印的，所以也不会产生keypress事件</p></li>
<li><p>不能打印的功能按键，如Backspace、Enter、Escape、 方向键、 PageUp、 PageDown、F1到F12</p></li>
<li><p>keydown事件对于功能案件来说是最有用的， 而keypress事件对于可打印案件来说是最有用的</p></li>
<li><p>不同的浏览器发送的keyCode、charCode等也有不同， 一般情况keyCode存储较低层的虚拟按键码并和keydown事件一起发送， charCode存储了可打印的字符编码和keypress一起发送， 如果一个功能按键产生了keypress事件， 那么keyCode是0(firefox中)， 另外在IE中只有一个keyCode属性，当keydown触发时他代码虚拟按键码，keypress触发时，代表字符码</p></li>
<li><p>可使用 String.fromCharCode(&lsquo;0x57&rsquo;)来将字符码转换为字符</p></li>
</ul>


<h3>判断特性</h3>

<p>判断DOM标准的方法： document.implementation.hasFeature(&lsquo;Events&rsquo;, &lsquo;2.0&rsquo;)</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/10/10/composite/">组合关系与组合模式</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-10-10T19:12:00+08:00" pubdate data-updated="true">Oct 10<span>th</span>, 2013</time>
        

        
      </p>
    
  </header>


  <div class="entry-content"><h3>组合（Composite）</h3>

<p>对象A包含对象B，对象B离开对象A没有实际意义。是一种更强的关联关系。人包含手，手离开人的躯体就失去了它应有的作用。</p>

<p>场景： Window窗体由滑动条slider、头部Header 和工作区Panel组合而成。
<img src="/images/NewComposite.png"></p>

<h4>组合模式</h4>

<p>将对象组合成树形结构以表示&#8221;部分-整体&#8221;的层次结构。 组合模式使得用户对单个对象和组合对象的使用具有一致性.</p>

<p>YUI widget的相关设计中插件和扩展机制，都能实现这个组合的模型，具体运用起来, 可对比如下:</p>

<h3>1. 普通的mixin || 组合</h3>

<ul>
<li>mixin 是一种不需要用到严格的继承就可以复用代码的一种技术。如果多个类想用到某个类的某个方法，可以通过扩充这些类的原型已达到共享该方法。</li>
<li>YUI widget设计中大量采用了这种方式，如base-base、 attribute-base等模块，目的是提供一个统一的外部功能调用的入口</li>
<li>模糊被组合对象的功能所属</li>
<li>Widget中的oop提供的build增加扩展的方式，本质上也是mixin</li>
</ul>


<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kd">function</span> <span class="nx">Slider</span><span class="p">()</span> <span class="p">{}</span>
</span><span class='line'><span class="nx">Slider</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">drag</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">function</span> <span class="nx">Header</span><span class="p">()</span> <span class="p">{</span> <span class="p">}</span>
</span><span class='line'><span class="nx">Header</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">addTitle</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">function</span> <span class="nx">Panel</span><span class="p">()</span> <span class="p">{</span> <span class="p">}</span>
</span><span class='line'><span class="nx">Panel</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">doSomething</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">function</span> <span class="nx">Window</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">Slider</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">);</span>
</span><span class='line'>    <span class="nx">Header</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">);</span>
</span><span class='line'>    <span class="nx">Panel</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="nx">Y</span><span class="p">.</span><span class="nx">mix</span><span class="p">(</span><span class="nx">Window</span><span class="p">,</span> <span class="nx">Slider</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
</span><span class='line'><span class="nx">Y</span><span class="p">.</span><span class="nx">mix</span><span class="p">(</span><span class="nx">Window</span><span class="p">,</span> <span class="nx">Header</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
</span><span class='line'><span class="nx">Y</span><span class="p">.</span><span class="nx">mix</span><span class="p">(</span><span class="nx">Window</span><span class="p">,</span> <span class="nx">Panel</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<h3>2. plugin</h3>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kd">function</span> <span class="nx">Window</span><span class="p">(</span><span class="nx">config</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">this</span><span class="p">.</span><span class="nx">plug</span><span class="p">(</span><span class="nx">Header</span><span class="p">,</span> <span class="nx">config</span><span class="p">);</span>
</span><span class='line'>    <span class="k">this</span><span class="p">.</span><span class="nx">plug</span><span class="p">(</span><span class="nx">Slider</span><span class="p">,</span> <span class="nx">config</span><span class="p">);</span>
</span><span class='line'>    <span class="k">this</span><span class="p">.</span><span class="nx">plug</span><span class="p">(</span><span class="nx">Panel</span><span class="p">,</span> <span class="nx">config</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>虽然插件也能勉强实现功能，不过类似这种场景不太适合用插件来实现</p>

<ul>
<li>由于插件的NS机制, 插件对象的功能不能直接作为Window对象的功能调用</li>
<li>插件对象是基于实例, 也就是说每个window实例，都有三个相关的实例对象与其关联，浪费了资源</li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/10/09/plugin/">YUI3组件框架之plugin</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-10-09T10:05:00+08:00" pubdate data-updated="true">Oct 9<span>th</span>, 2013</time>
        

        
      </p>
    
  </header>


  <div class="entry-content"><h3>源码分析：</h3>

<p>plugin功能包括如下几个模块， 简单分析如下：</p>

<h4>pluginhost-base</h4>

<ul>
<li><p>维护对象 this._plugins = {}；</p></li>
<li><p>并提供方法: plug、unplug、hasplug、_destroyPlugins、_initPlugins</p></li>
<li><p>plug: 初始化插件实例，并与host进行关联</p></li>
</ul>


<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="k">if</span> <span class="p">(</span><span class="nx">Plugin</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">L</span><span class="p">.</span><span class="nx">isFunction</span><span class="p">(</span><span class="nx">Plugin</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">config</span> <span class="o">=</span> <span class="nx">Plugin</span><span class="p">.</span><span class="nx">cfg</span><span class="p">;</span>
</span><span class='line'>    <span class="nx">Plugin</span> <span class="o">=</span> <span class="nx">Plugin</span><span class="p">.</span><span class="nx">fn</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Plugin should be fn by now </span>
</span><span class='line'><span class="k">if</span> <span class="p">(</span><span class="nx">Plugin</span> <span class="o">&amp;&amp;</span> <span class="nx">Plugin</span><span class="p">.</span><span class="nx">NS</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">ns</span> <span class="o">=</span> <span class="nx">Plugin</span><span class="p">.</span><span class="nx">NS</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">config</span> <span class="o">=</span> <span class="nx">config</span> <span class="o">||</span> <span class="p">{};</span>
</span><span class='line'>    <span class="nx">config</span><span class="p">.</span><span class="nx">host</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">hasPlugin</span><span class="p">(</span><span class="nx">ns</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>        <span class="c1">// Update config </span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">[</span><span class="nx">ns</span><span class="p">].</span><span class="nx">setAttrs</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">this</span><span class="p">[</span><span class="nx">ns</span><span class="p">].</span><span class="nx">setAttrs</span><span class="p">(</span><span class="nx">config</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>        <span class="c1">// Create new instance </span>
</span><span class='line'>        <span class="k">this</span><span class="p">[</span><span class="nx">ns</span><span class="p">]</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Plugin</span><span class="p">(</span><span class="nx">config</span><span class="p">);</span>
</span><span class='line'>        <span class="k">this</span><span class="p">.</span><span class="nx">_plugins</span><span class="p">[</span><span class="nx">ns</span><span class="p">]</span> <span class="o">=</span> <span class="nx">Plugin</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>_initPlugins: 调用模块 pluginhost-config 中的_initConfigPlugins(config);

<ul>
<li>根据this._classes(原型链上的constructor对象)上的静态属性 _PLUG and _UNPLUG, 来初始化plugin</li>
<li>通过widget初始化时的config配置, 来初始化plugin</li>
<li>在YUI Widget体系中base-core模块用来初始化插件, 初始化所有ext和ATTRS后调用</li>
</ul>
</li>
</ul>


<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="nx">PluginHost</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="err">\</span><span class="nx">_initConfigPlugins</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">config</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Class Configuration</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">classes</span> <span class="o">=</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_getClasses</span><span class="p">)</span> <span class="o">?</span> <span class="k">this</span><span class="p">.</span><span class="nx">_getClasses</span><span class="p">()</span> <span class="o">:</span> <span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">constructor</span><span class="p">],</span>
</span><span class='line'>        <span class="nx">plug</span> <span class="o">=</span> <span class="p">[],</span>
</span><span class='line'>        <span class="nx">unplug</span> <span class="o">=</span> <span class="p">{},</span>
</span><span class='line'>        <span class="nx">constructor</span><span class="p">,</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">classPlug</span><span class="p">,</span> <span class="nx">classUnplug</span><span class="p">,</span> <span class="nx">pluginClassName</span><span class="p">;</span>
</span><span class='line'>    <span class="c1">// TODO: Room for optimization. Can we apply statically/unplug in same pass?</span>
</span><span class='line'>    <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="nx">classes</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">constructor</span> <span class="o">=</span> <span class="nx">classes</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>        <span class="nx">classUnplug</span> <span class="o">=</span> <span class="nx">constructor</span><span class="p">.</span><span class="nx">_UNPLUG</span><span class="p">;</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="nx">classUnplug</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="c1">// subclasses over-write</span>
</span><span class='line'>            <span class="nx">Y</span><span class="p">.</span><span class="nx">mix</span><span class="p">(</span><span class="nx">unplug</span><span class="p">,</span> <span class="nx">classUnplug</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="nx">classPlug</span> <span class="o">=</span> <span class="nx">constructor</span><span class="p">.</span><span class="nx">_PLUG</span><span class="p">;</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="nx">classPlug</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="c1">// subclasses over-write</span>
</span><span class='line'>            <span class="nx">Y</span><span class="p">.</span><span class="nx">mix</span><span class="p">(</span><span class="nx">plug</span><span class="p">,</span> <span class="nx">classPlug</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">for</span> <span class="p">(</span><span class="nx">pluginClassName</span> <span class="k">in</span> <span class="nx">plug</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="nx">plug</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">pluginClassName</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">unplug</span><span class="p">[</span><span class="nx">pluginClassName</span><span class="p">])</span> <span class="p">{</span>
</span><span class='line'>                <span class="k">this</span><span class="p">.</span><span class="nx">plug</span><span class="p">(</span><span class="nx">plug</span><span class="p">[</span><span class="nx">pluginClassName</span><span class="p">]);</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// User Configuration</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="nx">config</span> <span class="o">&amp;&amp;</span> <span class="nx">config</span><span class="p">.</span><span class="nx">plugins</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">this</span><span class="p">.</span><span class="nx">plug</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">plugins</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<h4>pluginhost-config</h4>

<ul>
<li>_initConfigPlugins</li>
<li>静态方法： plug、unplug</li>
<li>提供给Y.Base引用</li>
</ul>


<h4>base-pluginhost</h4>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="nx">mixin</span> <span class="nx">Base</span> <span class="nx">and</span> <span class="nx">PluginHost</span><span class="err">，</span> <span class="err">即：</span>
</span><span class='line'>
</span><span class='line'><span class="nx">Y</span><span class="p">.</span><span class="nx">mix</span><span class="p">(</span><span class="nx">Base</span><span class="p">,</span> <span class="nx">PluginHost</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
</span><span class='line'><span class="nx">Base</span><span class="p">.</span><span class="nx">plug</span> <span class="o">=</span> <span class="nx">PluginHost</span><span class="p">.</span><span class="nx">plug</span><span class="p">;</span>
</span><span class='line'><span class="nx">Base</span><span class="p">.</span><span class="nx">unplug</span> <span class="o">=</span> <span class="nx">PluginHost</span><span class="p">.</span><span class="nx">unplug</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<h4>plugin</h4>

<p><em>. 继承Y.Base
</em>. 提供AOP的一系列方法， 如：</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="nx">doBefore</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">strMethod</span><span class="p">,</span> <span class="nx">fn</span><span class="p">,</span> <span class="nx">context</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">host</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;host&quot;</span><span class="p">),</span> <span class="nx">handle</span><span class="p">;</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="nx">strMethod</span> <span class="k">in</span> <span class="nx">host</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// method</span>
</span><span class='line'>        <span class="nx">handle</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">beforeHostMethod</span><span class="p">(</span><span class="nx">strMethod</span><span class="p">,</span> <span class="nx">fn</span><span class="p">,</span> <span class="nx">context</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">host</span><span class="p">.</span><span class="nx">on</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// event</span>
</span><span class='line'>        <span class="nx">handle</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">onHostEvent</span><span class="p">(</span><span class="nx">strMethod</span><span class="p">,</span> <span class="nx">fn</span><span class="p">,</span> <span class="nx">context</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">return</span> <span class="nx">handle</span><span class="p">;</span>
</span><span class='line'><span class="p">},</span>
</span><span class='line'><span class="nx">doAfter</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="p">...</span>
</span><span class='line'><span class="p">},</span>
</span><span class='line'><span class="nx">onHostEvent</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">handle</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;host&quot;</span><span class="p">).</span><span class="nx">on</span><span class="p">(</span><span class="nx">type</span><span class="p">,</span> <span class="nx">fn</span><span class="p">,</span> <span class="nx">context</span> <span class="o">||</span> <span class="k">this</span><span class="p">);</span>
</span><span class='line'>    <span class="k">this</span><span class="p">.</span><span class="nx">_handles</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">handle</span><span class="p">);</span>
</span><span class='line'>    <span class="k">return</span> <span class="nx">handle</span><span class="p">;</span>
</span><span class='line'><span class="p">},</span>
</span><span class='line'><span class="nx">afterHostEvent</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="p">...</span>
</span><span class='line'><span class="p">},</span>
</span><span class='line'><span class="nx">beforeHostMethod</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="p">...</span>
</span><span class='line'><span class="p">},</span>
</span><span class='line'><span class="nx">afterHostMethod</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="p">...</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>总结</h3>

<h4>一、如何写一个插件</h4>

<p>1、 任何简单对象即可成为一个简单插件， 如:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kd">function</span> <span class="nx">NodeDrag</span><span class="p">(</span><span class="nx">config</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">host</span> <span class="o">=</span> <span class="nx">config</span><span class="p">.</span><span class="nx">host</span><span class="p">;</span>
</span><span class='line'>    <span class="nx">drag</span><span class="p">(</span><span class="nx">host</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="kd">function</span> <span class="nx">drag</span><span class="p">(</span><span class="nx">host</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="p">...</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>2、YUI的Plugin基类提供了基于事件的AOP机制支持，可以通过继承它在不影响原有代码逻辑前提下，通过对代码执行过程的控制，达到改变原有代码逻辑或者增加插件功能的效果， 如：</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kd">function</span> <span class="nx">NodeDrag</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">NodeDrag</span><span class="p">.</span><span class="nx">superclass</span><span class="p">.</span><span class="nx">constructor</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="nx">Y</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">NodeDrag</span><span class="p">,</span> <span class="nx">Y</span><span class="p">.</span><span class="nx">Plugin</span><span class="p">.</span><span class="nx">Base</span><span class="p">,</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">drag</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="p">...</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<h4>二、使用插件的几种方式</h4>

<p>给一个node节点添加一个插件</p>

<p>1、使用Base的静态方法, 实际调用的是pluginhost-config里面的plug方法</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="nx">Y</span><span class="p">.</span><span class="nx">Base</span><span class="p">.</span><span class="nx">plug</span><span class="p">(</span><span class="nx">Y</span><span class="p">.</span><span class="nx">one</span><span class="p">(</span><span class="s1">&#39;#foo&#39;</span><span class="p">),</span> <span class="nx">NodeDrag</span><span class="p">,</span> <span class="nx">config</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>2、node对象和继承了Y.Base对象的实例都可以通过实例直接调用plug方法使用插件</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="nx">Y</span><span class="p">.</span><span class="nx">one</span><span class="p">(</span><span class="s1">&#39;#foo&#39;</span><span class="p">).</span><span class="nx">plug</span><span class="p">(</span><span class="nx">NodeDrag</span><span class="p">,</span> <span class="nx">config</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>3、具体widget</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kd">function</span> <span class="nx">Widget</span><span class="p">()</span> <span class="p">{}</span>
</span><span class='line'><span class="nx">Y</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">Widget</span><span class="p">,</span> <span class="nx">Y</span><span class="p">.</span><span class="nx">Base</span><span class="p">,</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">initializer</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="p">...</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">});</span>
</span><span class='line'><span class="kd">var</span> <span class="nx">w</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Widget</span><span class="p">({</span><span class="nx">plugins</span><span class="o">:</span> <span class="nx">NodeDrag</span><span class="p">});</span>
</span><span class='line'><span class="c1">//var w = new Widget({plugins: [NodeDrag, ..]});</span>
</span><span class='line'><span class="c1">//var w = new Widget({plugins: {fn: NodeDrag, cfg: {} });</span>
</span><span class='line'><span class="c1">//w.plug(NodeDrag, cfg);</span>
</span></code></pre></td></tr></table></div></figure>


<p>在一些情况，为了让调用者不必过多的关心实现细节的时候，也将插件的初始化放到具体widget的实现中, 如：</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="nx">Widget</span><span class="p">.</span><span class="nx">ATTRS</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">drag</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">value</span><span class="o">:</span> <span class="kc">false</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'><span class="nx">Y</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">Widget</span><span class="p">,</span> <span class="nx">Y</span><span class="p">.</span><span class="nx">Base</span><span class="p">,</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">initializer</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;drag&#39;</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">this</span><span class="p">.</span><span class="nx">plug</span><span class="p">(</span><span class="nx">NodeDrag</span><span class="p">,</span> <span class="nx">cfg</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<h4>三、插件的一些优势和适合的场景</h4>

<ul>
<li>插件一般是基于host开发的扩展功能， 用以对host功能的增强，如一些动画效果、也类如dota游戏中一些英雄所具有的各种技能等</li>
<li>插件机制能对复杂功能进行更好的抽象, 减少代码逻辑的耦合

<ul>
<li>如，在代码中由于加入一个功能，会涉及到很多代码片段加入if else 判断逻辑, 那么可以考虑将这个功能作为一个plugin增强， 使用AOP的方式与原来代码逻辑关联起来</li>
</ul>
</li>
<li>通过host进行统一的入口管理</li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/10/08/dui-xiang-lei-xing-he-biao-da-shi-yun-suan/">数据类型及转换</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-10-08T19:36:00+08:00" pubdate data-updated="true">Oct 8<span>th</span>, 2013</time>
        

        
      </p>
    
  </header>


  <div class="entry-content"><p>此篇数据类型和转换只限于ECMA规范，规范用了比较大的篇幅讲数据类型和类型转换，理解了这个最基本的概念对表达式、语句、执行环境、对象及继承都有非常大的帮助，遂整理如下：</p>

<h3>数据类型和值</h3>

<table>
  <tbody>
    <tr>
      <th width="100px">数据类型</th>
      <th>值demo</th>
      <th colspan="1">备注</th>
    </tr>
    <tr>
      <td>Undefined</td>
      <td>undefined</td>
      <td colspan="1">
        <span style="color: rgb(0,0,0);">当声明的变量未初始化时，该变量的默认值是 undefined</span>
      </td>
    </tr>
    <tr>
      <td colspan="1">Null</td>
      <td colspan="1">null</td>
      <td colspan="1">
        <span style="color: rgb(0,0,0);">typeof null == &#8220;object&#8221;</span>
      </td>
    </tr>
    <tr>
      <td colspan="1">Boolean</td>
      <td colspan="1">true、false</td>
      <td colspan="1">
        <span style="color: rgb(0,0,0);">
          <span>有且只有</span>两个值</span>
      </td>
    </tr>
    <tr>
      <td colspan="1">String</td>
      <td colspan="1"> &#8217;abc&#8217;, &#8220;abc&#8221;</td>
      <td colspan="1">
        <span style="color: rgb(0,0,0);">所有有限的零个或多个 16 位无符号整数值（“元素”）的有序序列</span>
      </td>
    </tr>
    <tr>
      <td colspan="1">Number</td>
      <td colspan="1"> <span style="color: rgb(0,0,0);">如5、12、-5、2e5、NaN</span>
      </td>
      <td colspan="1"> </td>
    </tr>
    <tr>
      <td colspan="1">Object</td>
      <td colspan="1">{}, []</td>
      <td colspan="1">
        <p class="li1">原生对象，包括内置对象和<span style="color: rgb(0,100,0);">程序执行过程中构建的对象</span>
        </p>
      </td>
    </tr>
  </tbody>
</table>


<h3>ECMAScript其它的一些数据类型， 大多数类型在语言内部使用</h3>

<table>
  <tbody>
    <tr>
      <th>数据类型</th>
      <th>备注</th>
    </tr>
    <tr>
      <td colspan="1">引用规范类型</td>
      <td colspan="1">
        <span style="color: rgb(0,0,0);">引用类型用来说明 delete，typeof，赋值运算符这些运算符的行为</span>
      </td>
    </tr>
    <tr>
      <td colspan="1">列表规范类型</td>
      <td colspan="1">
        <span style="color: rgb(0,0,0);">列表类型用于说明 new 表达式，函数调用，其他需要值的简单列表的算法 &#8211; 里的参数列表的计算</span>
      </td>
    </tr>
    <tr>
      <td colspan="1">完结规范类型</td>
      <td colspan="1">
        <span style="color: rgb(0,0,0);">完结类型用于说明执行将控制转移到外部的声明 (break, continue, return, throw) 的行为</span>
      </td>
    </tr>
    <tr>
      <td colspan="1">
        <p>属性描述符及属性标识符规范类型</p>
      </td>
      <td colspan="1">
        <span style="color: rgb(0,0,0);">属性描述符类型是用来解释命名属性的具体的操作的特性集</span>
      </td>
    </tr>
    <tr>
      <td colspan="1">词法环境和环境记录项规范类型</td>
      <td colspan="1">作用域及作用域链的相关定义会使用</td>
    </tr>
  </tbody>
</table>


<h3>类型转换</h3>

<p>表达式运算的重要前提是类型转换</p>

<table style="text-align: center;">
  <tbody>
    <tr>
      <th width="80px">输入类型</th>
      <th><span style="color: rgb(0,51,102);">ToPrimitive</span></th>
      <th colspan="1"><span style="color: rgb(0,51,102);"> ToBoolean</span></th>
      <th colspan="1">
        <span style="color: rgb(0,51,102);">ToNumber</span>
      </th>
      <th colspan="1">
        <span style="color: rgb(0,51,102);">ToString</span>
      </th>
      <th colspan="1" width="120px">
        <span style="color: rgb(0,51,102);">ToObject</span>
      </th>
    </tr>
    <tr>
      <td>Undefined</td>
      <td>不转换</td>
      <td colspan="1">false</td>
      <td colspan="1">NaN</td>
      <td colspan="1">&#8220;undefined&#8221;</td>
      <td colspan="1">
        <span style="color: rgb(0,0,0);">TypeError</span>
      </td>
    </tr>
    <tr>
      <td>Null</td>
      <td>
        <span>不转换</span>
      </td>
      <td colspan="1">false</td>
      <td colspan="1">+0</td>
      <td colspan="1">&#8220;null&#8221;</td>
      <td colspan="1">
        <span style="color: rgb(0,0,0);">TypeError</span>
      </td>
    </tr>
    <tr>
      <td>Boolean</td>
      <td>
        <span>不转换</span>
      </td>
      <td colspan="1">不转换</td>
      <td colspan="1">false->+0，true->1</td>
      <td colspan="1">true->&#8221;true&#8221;, false->&#8221;false&#8221;</td>
      <td colspan="1">
        <p>new Boolean(参数)，<span style="color: rgb(0,0,0);font-size: 10.0pt;line-height: 13.0pt;">设置[[PrimitiveValue]] 为参数值</span>
        </p>
      </td>
    </tr>
    <tr>
      <td>Number</td>
      <td>
        <span>不转换</span>
      </td>
      <td colspan="1">[+-]0、NaN->false</td>
      <td colspan="1">不转换</td>
      <td colspan="1">见规范9.8.1</td>
      <td colspan="1">
        <span>new Number(参数)，</span>
        <span style="color: rgb(0,0,0);">设置[[PrimitiveValue]] 为参数值</span>
      </td>
    </tr>
    <tr>
      <td>String</td>
      <td>
        <span>不转换</span>
      </td>
      <td colspan="1">&#8221;&#8221;->false</td>
      <td colspan="1">转化比较复杂，见规范9.3.1</td>
      <td colspan="1">不转换</td>
      <td colspan="1">
        <span>new String(参数)，</span>
        <span style="color: rgb(0,0,0);">设置[[PrimitiveValue]] 为参数值</span>
      </td>
    </tr>
    <tr>
      <td colspan="1">Object</td>
      <td colspan="1">
        <p>
          <span style="color: rgb(0,0,0);">调用该对象的内部方法</span>
        </p>
        <p>
          <span style="color: rgb(0,0,0);">[[DefaultValue]]返回值</span>
        </p>
      </td>
      <td colspan="1">
        <span style="color: rgb(0,0,0);">true</span>
      </td>
      <td colspan="1">
          ToNumber(ToPrimitive(hint:数值类型)</span>
      </td>
      <td colspan="1">
          ToString(ToPrimitive( hint:字符串值类型))
      </td>
      <td colspan="1">不转换</td>
    </tr>
  </tbody>
</table>


<h3>[[ DefaultValue ]](hint)算法</h3>

<ol>
<li><p>无参数时：</p>

<ul>
<li>hint = (O instanceof Date) ? &ldquo;字符串值类型&#8221; : &#8220;数字类型&rdquo;</li>
<li>[[ DefaultValue ]](hint)</li>
</ul>
</li>
<li><p>参数为字符串类型： </p>

<ul>
<li>调用对象的toString方法， 如果存在且返回结果是原始值，返回该原始值</li>
<li>调用对象的valueOf方法， 如果存在且返回结果是原始值，返回该原始值</li>
<li>否则抛出一个 TypeError 异常</li>
</ul>
</li>
<li><p>参数为数字类型：</p>

<ul>
<li>调用对象的valueOf方法， 如果存在且返回结果是原始值，返回该原始值</li>
<li>调用对象的toString方法， 如果存在且返回结果是原始值，返回该原始值</li>
<li>否则抛出一个 TypeError 异常</li>
</ul>
</li>
</ol>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/09/22/ju-zhen-da-yin/">矩阵打印</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-09-22T14:30:00+08:00" pubdate data-updated="true">Sep 22<span>nd</span>, 2013</time>
        

        
      </p>
    
  </header>


  <div class="entry-content"><p>在群里看到一道题目, 按一定的方式打印矩阵中相应位置的值</p>

<p><img src="/images/timu.jpg"></p>

<h3>看到题目直接写的代码草稿:</h3>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kd">function</span> <span class="nx">getNum</span><span class="p">(</span><span class="nx">n</span><span class="p">,</span> <span class="nx">type</span><span class="p">,</span> <span class="nx">arr</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">exp</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;i&quot;</span><span class="p">,</span> <span class="s2">&quot;i * (n-1) +1&quot;</span><span class="p">,</span> <span class="s2">&quot;(n-1)*n+i&quot;</span><span class="p">,</span> <span class="s2">&quot;n*(n-i-1) + (n-i)&quot;</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">temp</span> <span class="o">=</span> <span class="p">[];</span>
</span><span class='line'>    <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="nx">i</span><span class="o">&lt;=</span><span class="nx">n</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">if</span><span class="p">(</span><span class="nx">type</span> <span class="o">===</span> <span class="mi">1</span><span class="p">){</span>
</span><span class='line'>            <span class="nx">arr</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nb">eval</span><span class="p">(</span><span class="nx">exp</span><span class="p">[</span><span class="nx">type</span><span class="p">]));</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="k">if</span><span class="p">(</span><span class="nx">type</span> <span class="o">===</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nx">i</span> <span class="o">!==</span> <span class="nx">n</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="nx">arr</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nb">eval</span><span class="p">(</span><span class="nx">exp</span><span class="p">[</span><span class="nx">type</span><span class="p">]));</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="k">if</span><span class="p">(</span><span class="nx">type</span> <span class="o">===</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="nx">i</span> <span class="o">!==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="nx">arr</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nb">eval</span><span class="p">(</span><span class="nx">exp</span><span class="p">[</span><span class="nx">type</span><span class="p">]));</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="k">if</span><span class="p">(</span><span class="nx">type</span> <span class="o">===</span> <span class="mi">3</span> <span class="o">&amp;&amp;</span> <span class="nx">i</span> <span class="o">!==</span> <span class="nx">n</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="nx">arr</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nb">eval</span><span class="p">(</span><span class="nx">exp</span><span class="p">[</span><span class="nx">type</span><span class="p">]));</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">n</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">arr</span> <span class="o">=</span> <span class="p">[];</span>
</span><span class='line'>    <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">getNum</span><span class="p">(</span><span class="nx">n</span><span class="p">,</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">arr</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">arr</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">));</span>
</span><span class='line'><span class="p">})(</span><span class="mi">5</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<h3>代码解耦:</h3>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kd">function</span> <span class="nx">getNum</span><span class="p">(</span><span class="nx">n</span><span class="p">,</span> <span class="nx">type</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">exp</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;i&quot;</span><span class="p">,</span> <span class="s2">&quot;i * (n-1) +1&quot;</span><span class="p">,</span> <span class="s2">&quot;(n-1)*n+i&quot;</span><span class="p">,</span> <span class="s2">&quot;n*(n-i-1) + (n-i)&quot;</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">temp</span> <span class="o">=</span> <span class="p">[];</span>
</span><span class='line'>    <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="nx">i</span><span class="o">&lt;=</span><span class="nx">n</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">if</span><span class="p">(</span><span class="nx">type</span> <span class="o">===</span> <span class="mi">1</span><span class="p">){</span>
</span><span class='line'>            <span class="nx">temp</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nb">eval</span><span class="p">(</span><span class="nx">exp</span><span class="p">[</span><span class="nx">type</span><span class="p">]));</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="k">if</span><span class="p">(</span><span class="nx">type</span> <span class="o">===</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nx">i</span> <span class="o">!==</span> <span class="nx">n</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="nx">temp</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nb">eval</span><span class="p">(</span><span class="nx">exp</span><span class="p">[</span><span class="nx">type</span><span class="p">]));</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="k">if</span><span class="p">(</span><span class="nx">type</span> <span class="o">===</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="nx">i</span> <span class="o">!==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="nx">temp</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nb">eval</span><span class="p">(</span><span class="nx">exp</span><span class="p">[</span><span class="nx">type</span><span class="p">]));</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="k">if</span><span class="p">(</span><span class="nx">type</span> <span class="o">===</span> <span class="mi">3</span> <span class="o">&amp;&amp;</span> <span class="nx">i</span> <span class="o">!==</span> <span class="nx">n</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="nx">temp</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nb">eval</span><span class="p">(</span><span class="nx">exp</span><span class="p">[</span><span class="nx">type</span><span class="p">]));</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">return</span> <span class="nx">temp</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">n</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">arr</span> <span class="o">=</span> <span class="p">[];</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">temp</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
</span><span class='line'>    <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">temp</span> <span class="o">=</span> <span class="nx">getNum</span><span class="p">(</span><span class="nx">n</span><span class="p">,</span> <span class="nx">i</span><span class="p">);</span>
</span><span class='line'>        <span class="nx">arr</span> <span class="o">=</span> <span class="nx">arr</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span><span class="nx">temp</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">arr</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">));</span>
</span><span class='line'><span class="p">})(</span><span class="mi">5</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<h3>代码最终优化后：</h3>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kd">function</span> <span class="nx">getNum</span><span class="p">(</span><span class="nx">n</span><span class="p">,</span> <span class="nx">type</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">exp</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;i&quot;</span><span class="p">,</span> <span class="s2">&quot;i * (n-1) +1&quot;</span><span class="p">,</span> <span class="s2">&quot;(n-1)*n+i&quot;</span><span class="p">,</span> <span class="s2">&quot;n*(n-i-1) + (n-i)&quot;</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">temp</span> <span class="o">=</span> <span class="p">[];</span>
</span><span class='line'>    <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="nx">i</span><span class="o">&lt;=</span><span class="nx">n</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">if</span><span class="p">(</span><span class="nx">type</span> <span class="o">===</span> <span class="mi">1</span> <span class="o">||</span> <span class="p">((</span><span class="nx">type</span> <span class="o">===</span> <span class="mi">0</span> <span class="o">||</span> <span class="nx">type</span> <span class="o">===</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">i</span> <span class="o">!==</span> <span class="nx">n</span><span class="p">)</span> <span class="o">||</span>
</span><span class='line'>        <span class="p">(</span><span class="nx">type</span> <span class="o">===</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="nx">i</span> <span class="o">!==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>            <span class="nx">temp</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nb">eval</span><span class="p">(</span><span class="nx">exp</span><span class="p">[</span><span class="nx">type</span><span class="p">]));</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">return</span> <span class="nx">temp</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">n</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">arr</span> <span class="o">=</span> <span class="p">[];</span>
</span><span class='line'>    <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">arr</span> <span class="o">=</span> <span class="nx">arr</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span><span class="nx">getNum</span><span class="p">(</span><span class="nx">n</span><span class="p">,</span> <span class="nx">i</span><span class="p">));</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">arr</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">));</span>
</span><span class='line'><span class="p">})(</span><span class="mi">5</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>当然目前这个code只能满足从1开始递增的数据, 当然如果是随意的矩阵， 只需要将n维矩阵转换为一维数组，同时结果作为数组下标即可得到输出；</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/09/18/ec-plus-vo-plus-scope-for-es3/">EC+VO+SCOPE for ES3</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-09-18T23:11:00+08:00" pubdate data-updated="true">Sep 18<span>th</span>, 2013</time>
        

        
      </p>
    
  </header>


  <div class="entry-content"><h2>词法环境</h2>

<h4>词法作用域</h4>

<p>词法作用域（lexcical scope）。即JavaScript变量的作用域是在定义时决定而不是执行时决定，也就是说词法作用域取决于源码。</p>

<h4>词法环境</h4>

<p>用于定义特定变量和函数标识符在ECMAScript代码的词法嵌套结构上的关联关系， 一个词法环境由一个环境记录项和可能为空的外部词法环境引用构成</p>

<p>词法环境 = 词法环境记录项 + 外部词法环境<br/>
外部词法环境是包含内部词法环境的词法环境， 外部词法环境可能有多个内部词法环境</p>

<p>环境记录项 = 声明式环境记录项 || 对象式环境记录项</p>

<h2>执行环境</h2>

<ul>
<li><p>javascript引擎在执行每个函数实例时，都会创建一个执行环境（execution context）</p></li>
<li><p>执行环境中包含一个调用对象（call object）, 调用对象是一个scriptObject结构（scriptObject是与函数相关的一套静态系统，与函数实例的生命周期保持一致），用来保存内部变量表varDecls、内嵌函数表funDecls、父级引用列表upvalue等语法分析结构。 varDecls和funDecls等信息是在语法分析阶段就已经得到，并保存在语法树中</p></li>
<li><p>函数实例执行时，会将这些信息从语法树复制到scriptObject上</p></li>
</ul>


<h2>Executable Code and Execution contents</h2>

<p>“执行上下文”可以看做当前代码的运行环境或者作用域。</p>

<h4>Types of Executable Code</h4>

<ul>
<li><p> Global Code：全局级别的代码 – 这个是默认的代码运行环境，一旦代码被载入，引擎最先进入的就是这个环境。</p></li>
<li><p> Function Code: 函数级别的代码 – 当执行一个函数时，运行函数体中的代码。</p></li>
<li><p> Eval Code:  在Eval函数内运行的代码，在特定的一次对 eval 的调用过程中，eval 代码作为该程序的 Global Code 部分。</p></li>
</ul>


<p>每当调用执行一个函数时，引擎就会自动新建出一个函数上下文, 函数中函数也可能调用另一个函数，这样又创建一个执行环境， 也被称为上下文堆栈</p>

<h4>执行上下文堆栈</h4>

<ul>
<li><p>ECMAScript的程序执行都可以看做是一个执行上下文堆栈[execution context (EC) stack]。堆栈的顶部就是处于激活状态的上下文， 堆栈最底部即为全局执行上下文环境[global execution context]；</p></li>
<li><p>激活其它上下文的某个上下文被称为 调用者(caller) 。被激活的上下文被称为被调用者(callee) 。被调用者同时也可能是调用者(比如一个在全局上下文中被调用的函数调用某些自身的内部方法)。</p></li>
<li><p>当一个caller激活了一个callee，那么这个caller就会暂停它自身的执行，然后将控制权交给这个callee. 于是这个callee被放入堆栈，称为进行中的上下文[running/active execution context]. 当这个callee的上下文结束之后，会把控制权再次交给它的caller，然后caller会在刚才暂停的地方继续执行。在这个caller结束之后，会继续触发其他的上下文。一个callee可以用返回（return）或者抛出异常（exception）来结束自身的上下文。</p></li>
</ul>


<h4>执行上下文的建立过程</h4>

<p>每当调用一个函数时，一个新的执行上下文就会被创建出来。然而，在javascript引擎内部，这个上下文的创建过程具体分为两个阶段:</p>

<ol>
<li><p>建立阶段(发生在当调用一个函数时，但是在执行函数体内的具体代码以前)</p>

<ul>
<li>建立变量，函数，arguments对象，参数</li>
<li>建立作用域链</li>
<li>确定this的值</li>
</ul>
</li>
<li><p>代码执行阶段:</p>

<ul>
<li>变量赋值，函数引用，执行其它代码</li>
</ul>
</li>
</ol>


<p>实际上，可以把执行上下文看做一个对象，其下包含了以上3个属性：</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'> <span class="nx">executionContextObj</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">variableObject</span><span class="o">:</span> <span class="p">{</span> <span class="cm">/* 函数中的arguments对象, 参数, 内部的变量以及函数声明 */</span> <span class="p">},</span>
</span><span class='line'>    <span class="nx">scopeChain</span><span class="o">:</span> <span class="p">{</span>   <span class="cm">/* variableObject 以及所有父执行上下文中的variableObject */</span> <span class="p">},</span>
</span><span class='line'>    <span class="k">this</span><span class="o">:</span> <span class="p">{}</span>
</span><span class='line'> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>变量对象(variable object)</h2>

<p>变量对象(缩写为VO)是一个与执行上下文相关的特殊对象，它存储着在上下文中声明的以下内容：</p>

<ol>
<li>变量 (var, 变量声明)</li>
<li>函数声明 (FunctionDeclaration, 缩写为FD);</li>
<li>函数的形参
注： 只有全局上下文的变量对象允许通过VO的属性名称来间接访问</li>
</ol>


<h4>不同执行上下文中的变量对象</h4>

<p>对于所有类型的执行上下文来说，变量对象的一些操作(如变量初始化)和行为都是共通的。从这个角度来看，把变量对象作为抽象的基本事物来理解更为容易。同样在函数上下文中也定义和变量对象相关的额外内容。</p>

<p>抽象变量对象VO (变量初始化过程的一般行为)</p>

<ol>
<li><p>全局上下文变量对象GlobalContextVO</p>

<p> (VO === this === global), VO:</p>

<ul>
<li>所有函数声明(FunctionDeclaration, FD)</li>
<li>所有变量声明(var, VariableDeclaration)</li>
</ul>
</li>
<li><p>函数上下文变量对象FunctionContextVO</p>

<p> (VO === AO, 并且添加了arguments和形参), AO:</p>

<ul>
<li>普通参数(formal parameters) 与特殊参数(arguments)对象</li>
<li>所有函数声明(FunctionDeclaration, FD)</li>
<li>所有变量声明(var, VariableDeclaration)</li>
</ul>
</li>
<li><p>eval上下文</p>

<ul>
<li>eval会使用全局变量对象或调用者的变量对象(eval的调用来源)</li>
<li>变量声明在顺序上跟在函数声明和形式参数声明之后，但不会干扰AO中已经存在的同名函数声明或形式参数声明</li>
<li>(function x() {}); 类似这样的函数表达式并不会影响AO</li>
<li>不管是使用var关键字(在全局上下文)还是不使用var关键字(在任何地方)，都可以声明一个变量”。 请记住，这是错误的概念； 任何时候，变量只能通过使用var关键字才能声明。</li>
</ul>
</li>
</ol>


<h4>变量的特性</h4>

<ol>
<li>变量有一个特性(attribute)：{DontDelete},这个特性的含义就是不能用delete操作符直接删除变量属性</li>
<li>eval上下文，变量没有{DontDelete}特性, 使用一些调试工具(例如：Firebug)的控制台测试该实例时，请注意，Firebug同样是使用eval来执行控制台里你的代码。因此，变量属性同样没有{DontDelete}特性，可以被删除。</li>
</ol>


<h2>作用域</h2>

<p>javascript变量的作用域是在定义时决定而不是执行时决定，也就是说词法作用域取决于源码，编译器通过静态分析就能确定，因此词法作用域也叫做静态作用域（static scope）。但需要注意，with和eval的语义无法仅通过静态技术实现，所以只能说javascript的作用域机制非常接近词法作用域（lexical scope）</p>

<h2>作用域链</h2>

<p>在ECMAScript中，会用到内部函数[inner functions]，在这些内部函数中，我们可能会引用它的父函数变量，或者全局的变量。我们把这些变量对象成为上下文作用域对象[scope object of the context]. 类似于上面讨论的原型链[prototype chain]，我们在这里称为作用域链[scope chain]</p>

<p>作用域链与一个执行上下文相关, 用于在标识符解析中变量查找。 标示符[Identifiers]可以理解为变量名称、函数声明和普通参数</p>

<p>函数上下文的作用域链在函数调用时创建的，包含活动对象和这个函数内部的[[scope]]属性。其scope定义如下：Scope = AO + [[Scope]]</p>

<p>函数在被创建时保存外部作用域，是因为这个 被保存的作用域链(saved scope chain) 将会在未来的函数调用中用于变量查找。这种形式的作用域称为静态作用域[static/lexical scope]</p>

<p>在上下文中示意如下：</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="nx">activeExecutionContext</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">VO</span><span class="o">:</span> <span class="p">{...},</span> <span class="c1">// or AO</span>
</span><span class='line'>    <span class="k">this</span><span class="o">:</span> <span class="nx">thisValue</span><span class="p">,</span>
</span><span class='line'>    <span class="nx">Scope</span><span class="o">:</span> <span class="p">[</span> <span class="c1">// Scope chain</span>
</span><span class='line'>      <span class="c1">// 所有变量对象的列表</span>
</span><span class='line'>      <span class="c1">// for identifiers lookup</span>
</span><span class='line'>    <span class="p">]</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kd">var</span> <span class="nx">x</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="kd">function</span> <span class="nx">foo</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">alert</span><span class="p">(</span><span class="nx">x</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">x</span> <span class="o">=</span> <span class="mi">20</span><span class="p">;</span>
</span><span class='line'>  <span class="nx">foo</span><span class="p">();</span> <span class="c1">// 10, but not 20</span>
</span><span class='line'><span class="p">})();</span>
</span></code></pre></td></tr></table></div></figure>


<p>在标识符解析过程中，使用函数创建时定义的词法作用域－－变量解析为10，而不是20。此外，这个例子也清晰的表明，一个函数（这个例子中为从函数“foo”返回的匿名函数）的[[scope]]持续存在，即使是在函数创建的作用域已经完成之后。</p>

<h4>补充说明</h4>

<ol>
<li><p>通过构造函数创建的函数的[[scope]]属性总是唯一的全局对象</p></li>
<li><p>在代码执行阶段有两个声明能修改作用域链。这就是with声明和catch语句</p></li>
<li><p>在代码执行过程中，如果使用with或者catch语句就会改变作用域链。而这些对象都是一些简单对象，他们也会有原型链。这样的话，作用域链会从两个维度来搜寻。</p></li>
<li><p>在解释执行阶段， 遇到变量需要解析时，会首先从当前执行环境的活动对象中查找， 如果没有找到而且该执行环境拥有者有prototype属性时， 则会从prototype链中查找， 否则将会按照作用域链查找；</p></li>
</ol>

</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/blog/page/2/">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2014/02/12/nodexue-xi-bi-ji-2-npmbao-guan-li/">Node学习笔记2 —— Npm包管理</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/02/12/nodexue-xi-bi-ji-1-requirefang-fa-zhong-de-wen-jian-cha-zhao-ce-lue/">Node学习笔记1——require参数查找策略</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/02/12/js-encode/">JS URI Encode</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/11/06/iframe/">Iframe及与页面之间的通信</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/10/30/events/">事件碎碎念</a>
      </li>
    
  </ul>
</section>





  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2014 - mininice -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'pinpinzhu';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
